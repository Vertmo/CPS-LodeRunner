\documentclass[8pt]{article}
\usepackage[a4paper, margin=0.5in]{geometry}
\usepackage{listings}
\usepackage{longtable}

\title{CPS - Projet - LodeRunner\\Spécification}
\author{Basile Pesin, David Sreng\\Sorbonne Université}

\begin{document}
\maketitle

\section{Jeu (partie commune)}

\subsection{Screen}

{\small
\begin{longtable}{rl}
  \textbf{Service}: & \textrm{Screen}  \\
  \textbf{Observators}: & \textbf{const}~\texttt{Height}: \textrm{[Screen]} $\rightarrow$ \textrm{int} \\
  & \textbf{const} \texttt{Width}: \textrm{[Screen]} $\rightarrow$ \textrm{int} \\
  & \texttt{CellNature}: \textrm{[Screen]} $\times$ \textrm{int} $\times$ \textrm{int} $\rightarrow$ \textrm{Cell} \\
  & \quad \textbf{pre } \texttt{CellNature(S,x,y)} \textbf{ requires } 0 $\leq$ \texttt{y} $<$ \texttt{Height(S)} \textbf{ and } 0 $\leq$ \texttt{x} $<$ \texttt{Width(S)}\\
  \textbf{Constructors}: & \texttt{init}: \textrm{int} $\times$ \textrm{int} $\rightarrow$ \textrm{[Screen]} \\
  & \quad \textbf{pre } \texttt{init(h,w)} \textbf{ requires } 0 $<$ \texttt{h} \textbf{ and } 0 $<$ \texttt{w} \\
  \textbf{Operators}: & \texttt{Dig}: \textrm{[Screen]} $\times$ \textrm{int} $\times$ \textrm{int}  $\rightarrow$ \textrm{[Screen]} \\
  & \quad \textbf{pre } \texttt{Dig(S,x,y)} \textbf{ requires } \texttt{CellNature(S,x,y)} $=$ \textbf{PLT} \\
  & \texttt{Fill}: \textrm{[Screen]} $\times$ \textrm{int} $\times$ \textrm{int}  $\rightarrow$ \textrm{[Screen]} \\
  & \quad \textbf{pre } \texttt{Dig(S,x,y)} \textbf{ requires } \texttt{CellNature(S,x,y)} $=$ \textbf{HOL} \\
  \textbf{Observations}: & \\
  \texttt{[init]}: & \texttt{Height(init(h,w))} $=$ \texttt{h} \\
  & \texttt{Width(init(h,w))} $=$ \texttt{w} \\
  & $\forall$ $(x,y)$ $\in$ \texttt{[0;Width(S)[}$\times$ \texttt{[0;Height(S)[},~ \texttt{CellNature(init(h,w),x,y)} $=$ \textbf{EMP} \\
  \texttt{[Dig]}: & \texttt{CellNature(Dig(S,x,y)),x,y} $=$ \textbf{HOL} \\
  & $\forall$ $(x,y)$ $\in$ \texttt{[0;Width(S)[} $\times$ \texttt{[0;Height(S)[}, \\
  & \quad\quad\quad\quad (\texttt{x} $\neq$ \texttt{u} $\lor$ \texttt{y} $\neq$ \texttt{v}) $\Rightarrow$ \texttt{CellNature(Dig(S,u,v)),x,y)} $=$ \texttt{CellNature(x,y)} \\
  \texttt{[Fill]}: & \texttt{CellNature(Fill(S,x,y),x,y)} $=$ \textbf{PLT} \\
  & $\forall$ $(x,y)$ $\in$ \texttt{[0;Width(S)[}$\times$ \texttt{[0;Height(S)[}, \\
  & \quad\quad\quad\quad (\texttt{x} $\neq$ \texttt{u} $\lor$ \texttt{y} $\neq$ \texttt{v}) $\Rightarrow$ \texttt{CellNature(Fill(S,u,v)),x,y)} $=$ \texttt{CellNature(x,y)} \\
\end{longtable}}

\subsection{EditableScreen}

{\small
\begin{longtable}{rl}
  \textbf{Service}: & \textrm{EditableScreen} {\bf includes} \textrm{Screen}  \\
  \textbf{Observators}: & \texttt{Playable}: \textrm{[EditableScreen]} $\rightarrow$ \textrm{bool} \\
  \textbf{Operators}: & \texttt{SetNature}: \textrm{[EditableScreen]} $\times$ \textrm{int} $\times$ \textrm{int} $\times$ \textrm{Cell}  $\rightarrow$ \textrm{[EditableScreen]} \\
  & \quad \textbf{pre } \texttt{SetNature(S,x,y,C)} \textbf{ requires } 0 $\leq$ \texttt{y} $<$ \texttt{Height(S)} \textbf{ and } 0 $\leq$ \texttt{x} $<$ \texttt{Width(S)}\\
  \textbf{Observations}: \\
  \texttt{[invariant]}: & \texttt{Playable(S)} \textbf{min} \\
  & \quad\quad\quad\quad $\forall$ $(x,y)$ $\in$ \texttt{[0;Width(S)[}$\times$ \texttt{[0;Height(S)[}, \texttt{CellNature(S,x,y)} $\neq$ \textbf{HOL}  \\
          & \quad\quad\quad\quad $\land$ $\forall$ $x$ $\in$ \texttt{[0;Width(S)[}, \texttt{CellNature(S,x,0)} $=$ \textbf{MTL}  \\
              \texttt{[SetNature]}: & \texttt{CellNature(SetNature(S,x,y,C)),x,y} $=$ C \\
              & $\forall$ $(x,y)$ $\in$ \texttt{[0;Width(S)[}$\times$ \texttt{[0;Height(S)[}, \\ & \quad\quad\quad\quad (\texttt{x} $\neq$ \texttt{u} $\lor$ \texttt{y} $\neq$ \texttt{v}) $\Rightarrow$ \texttt{CellNature(SetNature(S,u,v,C)),x,y)} $=$ \texttt{CellNature(x,y)} \\
\end{longtable}}

\subsection{Environment}

{\small
\begin{longtable}{rl}
  \textbf{Service}: & Environment \textbf{includes} Screen
  \\ \textbf{Observators} : & \texttt{CellContent}:
  \textrm{int} $\times$ \textrm{int} $\rightarrow$
  \textrm{Set\{Character + Item\}} \\
  & \quad \textbf{pre } \texttt{CellContent(E,x,y)} \textbf{ requires } 0 $\leq$ \texttt{y} $<$ \texttt{Height(S)} \textbf{ and } 0 $\leq$ \texttt{x} $<$ \texttt{Width(S)}\\
  \textbf{Constructors}: & \texttt{init}: \textrm{EditableScreen} $\rightarrow$ \textrm{Environment} \\
  \textbf{Operators}: & \texttt{AddCellContent}: \textrm{[EditableScreen]} $\times$ \textrm{int} $\times$ \textrm{int} $\times$ \textrm{(Character + Item)} $\rightarrow$ \textrm{[EditableScreen]}\\
  & \quad \textbf{pre} \texttt{AddCellContent(E, x, y, c)} \textbf{requires} \texttt{CellNature(E, Col(E), Hgt(E))} $=$ \textbf{EMP} \\ 
  & \quad\quad\quad $\land$ \texttt{CellNature(E, Col(E), Hgt(E)-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \texttt{RemoveCellContent}: \textrm{[EditableScreen]} $\times$ \textrm{int} $\times$ \textrm{int} $\times$ \textrm{(Character + Item)} $\rightarrow$ \textrm{[EditableScreen]} \\
  & \quad \textbf{pre} \texttt{RemoveCellContent(E, x, y, c)} \textbf{requires} \texttt{c} $\in$ \texttt{CellContent(E, x, y)}
  \textbf{Observations}: \\
  \texttt{[invariant]}: & $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(E)[}$\times$ \texttt{[0;Height(E)[}, \\
  & \quad\quad $\forall$ \textrm{Guard} \texttt{g1}, \texttt{g2} $\in$ \texttt{CellContent(E,x,y)}$^2$, \texttt{g1} $=$ \texttt{g2} \\
  & $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(E)[}$\times$ \texttt{[0;Height(E)[},~\\
  & \quad\quad \texttt{CellNature(E,x,y)} $\in$ \{\textbf{MTL}, \textbf{PLR}\} $\Rightarrow$ \texttt{CellContent(x,y)} $=$ $\emptyset$  \\
  & $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(E)[}$\times$ \texttt{[0;Height(E)[},~\\ & \quad\quad $\exists$ \textrm{Treasure} \texttt{t} $\in$ \texttt{CellContent(E,x,y)}  \\
  & \quad\quad $\Rightarrow$ (\texttt{CellNature(E,x,y)} $=$ \textbf{EMP} $\land$ \texttt{CellNature(E,x,y-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}\})\\
  \texttt{[init]}: & \texttt{Width(init(S))} $=$ \texttt{Width(S)} \\
  & \texttt{Height(init(S))} $=$ \texttt{Height(S)} \\
  & $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(E)[}$\times$ \texttt{[0;Height(E)[}, \\
  & \quad\quad \texttt{CellNature(init(S),x,y)} $=$ \textrm{EditableScreen}::\texttt{CellNature(S,x,y)} \\
  & $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(E)[}$\times$ \texttt{[0;Height(E)[}, \\
  & \quad\quad \texttt{CellContent(init(S),x,y)} $=$ $\emptyset$ \\
\end{longtable}}

\subsection{Character}

{\small
\begin{longtable}{rl}
  \textbf{Service}: & \textrm{Character}  \\
  \textbf{Observators}: & \textbf{const}~\texttt{Envi}: \textrm{[Character]} $\rightarrow$ \textrm{Environment}  \\
  & \texttt{Hgt}: \textrm{[Character]} $\rightarrow$ \textrm{int}  \\
  & \texttt{Col}: \textrm{[Character]} $\rightarrow$ \textrm{int}  \\
  \textbf{Operators}: & \texttt{init}: \textrm{Environment} $\times$ \textrm{int} $\times$ \textrm{int} $\rightarrow$ \textrm{[Character]} \\
  & \quad\textbf{pre} \textrm{init(E,x,y)} \textbf{requires} \textrm{Environment::CellNature(E,x,y)} $=$ \textbf{EMP} \\
  & \texttt{GoLeft}: \textrm{[Character]} $\rightarrow$ \textrm{[Character]} \\
  & \texttt{GoRight}: \textrm{[Character]} $\rightarrow$ \textrm{[Character]} \\
  & \texttt{GoUp}: \textrm{[Character]} $\rightarrow$ \textrm{[Character]} \\
  & \texttt{GoDown}: \textrm{[Character]} $\rightarrow$ \textrm{[Character]} \\
  \textbf{Observations}: \\
  \texttt{[invariant]}: & \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $\in$ \{\textbf{EMP}, \textbf{HOL}, \textbf{LAD}, \textbf{HDR}\} \\
  & $\exists$ \textrm{Character} \texttt{x} $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C))} $\Rightarrow$ \texttt{x} $=$ \texttt{C}  \\
  \texttt{[init]}: & \textrm{Envi(init(E, x, y))} $=$ \textrm{E} \\
  & \textrm{Col(init(E, x, y))} $=$ \textrm{x} \\
  & \textrm{Hgt(init(E, x, y))} $=$ \textrm{y} \\
  \texttt{[GoLeft]}: & \textrm{Hgt(GoLeft(C))} $=$ \textrm{Hgt(C)} \\
  & \textrm{Col(C)} $=$ 0 $\Rightarrow$ \textrm{Col(GoLeft(C))} = \textrm{Col(C)} \\
  & \textrm{Environment::CellNature(Envi(C),Col(C)-1,Hgt(C))} $\in$ \{\textbf{MTL}, \textbf{PLT} \} $\Rightarrow$ \textrm{Col(GoLeft(C))} = \textrm{Col(C)} \\
  & \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $\notin$ \{\textbf{LAD}, \textbf{HDR}\}
  \\ & \quad\quad $\land$ \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)-1)} $\notin$ \{\textbf{PLT}, \textbf{MTL}, \textbf{LAD} \} \\
  & \quad\quad $\land$ $\neg$$\exists$ \textrm{Character} c $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)-1)} \\
  & \quad\quad $\Rightarrow$ \textrm{Col(GoLeft(C))} = \textrm{Col(C)} \\
  & \textrm{C} $\in$ \textrm{Guard} $\land$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)-1,Hgt(C))} \\ & \quad\quad $\Rightarrow$ \textrm{Col(GoLeft(C))} = \textrm{Col(C)} \\
  & (\textrm{Col(C)} $\neq$ 0) $\land$ \textrm{Environment::CellNature(Envi(C),Col(C)-1,Hgt(C))} $\notin$ \{\textbf{MTL}, \textbf{PLT} \} \\
  & \quad\quad $\land$ (\textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $\in$ \{\textbf{LAD}, \textbf{HDR}\} \\
  & \quad\quad\quad\quad $\lor$ \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}, \textbf{LAD}\} \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Character} c $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)-1)} ) \\
  & \quad\quad $\land$ $\neg$ (\textrm{C} $\in$ \textrm{Guard} $\land$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)-1,Hgt(C))}) \\
  & \quad\quad $\Rightarrow$ \textrm{Col(GoLeft(C))} = \textrm{Col(C)}-1 \\
\texttt{[GoRight]}: & \textrm{Hgt(GoRight(C))} $=$ \textrm{Hgt(C)} \\
  & \textrm{Col(C)} $=$ 0 $\Rightarrow$ \textrm{Col(GoRight(C))} = \textrm{Col(C)} \\
  & \textrm{Environment::CellNature(Envi(C),Col(C)+1,Hgt(C))} $\in$ \{\textbf{MTL}, \textbf{PLT} \} $\Rightarrow$ \textrm{Col(GoRight(C))} = \textrm{Col(C)} \\
  & \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $\notin$ \{\textbf{LAD}, \textbf{HDR}\}
  \\ & \quad\quad $\land$ \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)-1)} $\notin$ \{\textbf{PLT}, \textbf{MTL}, \textbf{LAD} \} \\
  & \quad\quad $\land$ $\neg$$\exists$ \textrm{Character} c $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)-1)} \\
  & \quad\quad $\Rightarrow$ \textrm{Col(GoRight(C))} = \textrm{Col(C)} \\
  & \textrm{C} $\in$ \textrm{Guard} $\land$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)+1,Hgt(C))} \\ & \quad\quad $\Rightarrow$ \textrm{Col(GoRight(C))} = \textrm{Col(C)} \\
  & (\textrm{Col(C)} $\neq$ 0) $\land$ \textrm{Environment::CellNature(Envi(C),Col(C)+1,Hgt(C))} $\notin$ \{\textbf{MTL}, \textbf{PLT} \} \\
  & \quad\quad $\land$ (\textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $\in$ \{\textbf{LAD}, \textbf{HDR}\} \\
  & \quad\quad\quad\quad $\lor$ \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}, \textbf{LAD}\} \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Character} c $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)-1)} ) \\
  & \quad\quad $\land$ $\neg$ (\textrm{C} $\in$ \textrm{Guard} $\land$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)+1,Hgt(C))}) \\
  & \quad\quad $\Rightarrow$ \textrm{Col(GoRight(C))} = \textrm{Col(C)}+1 \\
\texttt{[GoUp]}: & \textrm{Col(GoUp(C))} $=$ \textrm{Col(C)} \\
  & \textrm{Hgt(C)} $=$ \textrm{Environment::Height(Envi(C))-1} $\Rightarrow$ \textrm{Hgt(GoUp(C))} = \textrm{Hgt(C)} \\
  & \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $=$ \textbf{LAD} \\
  & \quad\quad $\land$ \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)+1)} $\notin$ \{\textbf{PLT}, \textbf{MTL} \} \\
  & \quad\quad $\land$ (\textrm{C} $\notin$ \textrm{Guard} $\lor$ $\neg$$\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)+1)}) \\
  & \quad\quad $\Rightarrow$ \textrm{Hgt(GoUp(C))} = \textrm{Hgt(C)}+1 \\
  & \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $\neq$ \textbf{LAD} \\
  & \quad\quad $\lor$ \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)+1)} $\in$ \{\textbf{PLT}, \textbf{MTL} \} \\
  & \quad\quad $\lor$ (\textrm{C} $\in$ \textrm{Guard} $\land$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)+1)}) \\
  & \quad\quad $\Rightarrow$ \textrm{Hgt(GoUp(C))} = \textrm{Hgt(C)} \\
\texttt{[GoDown]}: & \textrm{Col(GoDown(C))} $=$ \textrm{Col(C)} \\
  & \textrm{Hgt(C)} $=$ 0 $\Rightarrow$ \textrm{Hgt(GoDown(C))} = \textrm{Hgt(C)} \\
  & \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)+1)} $\notin$ \{\textbf{PLT}, \textbf{MTL} \} \\
  & \quad\quad $\land$ (\textrm{C} $\notin$ \textrm{Guard} $\lor$ $\neg$$\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)+1)}) \\
  & \quad\quad $\Rightarrow$ \textrm{Hgt(GoDown(C))} = \textrm{Hgt(C)}-1 \\
  & \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)+1)} $\in$ \{\textbf{PLT}, \textbf{MTL} \} \\
  & \quad\quad $\lor$ (\textrm{C} $\in$ \textrm{Guard} $\land$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)+1)}) \\
  & \quad\quad $\Rightarrow$ \textrm{Hgt(GoDown(C))} = \textrm{Hgt(C)} \\
\end{longtable}}

\subsection{Guard}

{\small
\begin{longtable}{rl}
  \textbf{Service}: & \textrm{Guard} \textbf{includes} \textrm{Character}  \\
  \textbf{Observators}: & \textbf{const} \texttt{Id}: \textrm{[Guard]} $\rightarrow$ \textrm{int}  \\
  & \textbf{const} \texttt{InitCol}: \textrm{[Guard]} $ \rightarrow $ \textrm{int} \\
  & \textbf{const} \texttt{InitHgt}: \textrm{[Guard]} $ \rightarrow $ \textrm{int} \\
  & \texttt{Behaviour}: \textrm{[Guard]} $\rightarrow$ \textrm{Move}  \\
  & \texttt{Target}: \textrm{[Guard]} $\rightarrow$ \textrm{Character}  \\
  & \texttt{TimeInHole}: \textrm{[Guard]} $\rightarrow$ \textrm{int}  \\
  & \quad\quad \textbf{pre} \texttt{TimeInHole(G)} \textbf{requires} \texttt{Environment::CellNature(Envi(G),Hgt(G),Col(G))} $=$ \textbf{HOL} \\
  \textbf{Operators}: & \texttt{ClimbLeft}: \textrm{[Guard]} $\rightarrow$ \textrm{[Guard]}\\
  & \quad\quad \textbf{pre} \texttt{ClimbLeft(G)} \textbf{requires} \texttt{Environment::CellNature(Envi(G),Hgt(G),Col(G))} $=$ \textbf{HOL} \\
  \textbf{Operators}: & \texttt{ClimbRight}: \textrm{[Guard]} $\rightarrow$ \textrm{[Guard]}\\
  & \quad\quad \textbf{pre} \texttt{ClimbRight(G)} \textbf{requires} \texttt{Environment::CellNature(Envi(G),Hgt(G),Col(G))} $=$ \textbf{HOL} \\
  & \texttt{Step}: \textrm{[Guard]} $\rightarrow$ \textrm{[Guard]}\\
  \textbf{Observations}: & \\
  \textrm{[invariant]}: & \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad $\land$ \textrm{Hgt(G)} $<$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad $\land$ (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\notin$ \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)} \\
  & \quad\quad\quad\quad $\Rightarrow$ \textrm{Character::Hgt(Target(G)) - Hgt(G)} $<$ $|$\textrm{Character::Col(Target(G)) - Col(G)})$|$)\\
  & \quad\quad $\Rightarrow$ \textrm{Behaviour(G)} $=$ \textbf{Up} \\
  & \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad $\land$ \textrm{Hgt(G)} $>$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad $\land$ (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\notin$ \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)} \\
  & \quad\quad\quad\quad $\Rightarrow$ \textrm{Hgt(G) - Character::Hgt(Target(G))} $<$ $|$\textrm{Character::Col(Target(G)) - Col(G)})$|$)\\
  & \quad\quad $\Rightarrow$ \textrm{Behaviour(G)} $=$ \textbf{Down} \\
  & \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad $\land$ \textrm{Hgt(G)} $=$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad $\land$ ( \textrm{Col(G)} $=$ \textrm{Character::Col(Target(G))}\\
  & \quad\quad\quad\quad $\lor$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\notin$ \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)}) \\
  & \quad\quad $\Rightarrow$ \textrm{Behaviour(G)} $=$ \textbf{Neutral} \\
  & (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad $\lor$ ( \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad\quad\quad\quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\neq$ \textbf{LAD}) \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)}) \\
  & \quad\quad $\land$ \textrm{Col(G)} $<$ \textrm{Character::Col(Target(G))} \\
  & \quad\quad $\land$ (\textrm{Hgt(G)} $\neq$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad\quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD}\\
  & \quad\quad\quad\quad $\Rightarrow$ \textrm{Character::Col(Target(G)) - Col(G)} $<$ $|$\textrm{Character::Hgt(Target(G)) - Hgt(G)})$|$) \\
  & \quad\quad $\Rightarrow$ \textrm{Behaviour(G)} $=$ \textbf{Left} \\ 
  & (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad $\lor$ ( \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad\quad\quad\quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\neq$ \textbf{LAD}) \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)}) \\
  & \quad\quad $\land$ \textrm{Col(G)} $>$ \textrm{Character::Col(Target(G))} \\
  & \quad\quad $\land$ (\textrm{Hgt(G)} $\neq$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad\quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD}\\
  & \quad\quad\quad\quad $\Rightarrow$ \textrm{Col(G) - Character::Col(Target(G))} $<$ $|$\textrm{Character::Hgt(Target(G)) - Hgt(G)})$|$) \\
  & \quad\quad $\Rightarrow$ \textrm{Behaviour(G)} $=$ \textbf{Right} \\
  & (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad $\lor$ ( \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad\quad\quad\quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\neq$ \textbf{LAD}) \\
  & \quad\quad\quad\quad $\lor$ $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)}) \\
  & \quad\quad $\land$ \textrm{Col(G)} $=$ \textrm{Character::Col(Target(G))} \\
  & \quad\quad $\land$ (\textrm{Hgt(G)} $=$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad\quad\quad $\lor$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $\neq$ \textbf{LAD}) \\
  & \quad\quad $\Rightarrow$ \textrm{Behaviour(G)} $=$ \textbf{Neutral} \\
  \textrm{[init]}:
  & Envi(init(G, e, t, x, y)) = e \\
  & Col(init(G, e, t, x, y)) = InitCol(init(G, e, t, x, y)) = x \\
  & Hgt(init(G, e, t, x, y)) = InitHgt(init(G, e, t, x, y)) = y \\
  & Target(init(G, e, t, x, y)) = t \\
  \textrm{[ClimbLeft]}: 
  & \textrm{Col(C)} $=$ 0 $\Rightarrow$ \textrm{Col(ClimbLeft(C))} = \textrm{Col(C)} $\land$ \textrm{Hgt(ClimbLeft(C))} $=$ \textrm{Hgt(C)} \\
  & \textrm{Screen::CellNature(Envi(C),Col(C)-1,Hgt(C) +1)} $\in$ \{\textbf{MTL}, \textbf{PLT} \} \\ & \quad\quad $\Rightarrow$ \textrm{Col(ClimbLeft(C))} = \textrm{Col(C)} $\land$ \textrm{Hgt(ClimbLeft(C))} $=$ \textrm{Hgt(C)} \\
  & $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)-1,Hgt(C)+1)} \\
  & \quad\quad $\Rightarrow$ \textrm{Col(ClimbLeft(C))} = \textrm{Col(C)} $\land$ \textrm{Hgt(ClimbLeft(C))} $=$ \textrm{Hgt(C)} \\
  & \textrm{Col(C)} $\neq$ 0 $\land$ \textrm{Screen::CellNature(Envi(C),Col(C)-1,Hgt(C)+1)} \textbf{notin} \{\textbf{MTL}, \textbf{PLT} \} \\
  & \quad\quad $\land$ $\neg$$\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)-1,Hgt(C)+1)} \\
  & \quad\quad $\Rightarrow$ \textrm{Col(ClimbLeft(C))} = \textrm{Col(C)}-1 $\land$ \textrm{Hgt(ClimbLeft(C))} = \textrm{Hgt(C)}+1 \\
  \textrm{[ClimbRight]}: 
  & \textrm{Col(C)} $=$ Environnement::Width(Envi(G))-1 \\
  & \quad\quad $\Rightarrow$ \textrm{Col(ClimbRight(C))} = \textrm{Col(C)} $\land$ \textrm{Hgt(ClimbLeft(C))} $=$ \textrm{Hgt(C)} \\
  & \textrm{Screen::CellNature(Envi(C),Col(C)+1,Hgt(C) +1)} $\in$ \{\textbf{MTL}, \textbf{PLT} \} \\ & \quad\quad $\Rightarrow$ \textrm{Col(ClimbRight(C))} = \textrm{Col(C)} $\land$ \textrm{Hgt(ClimbLeft(C))} $=$ \textrm{Hgt(C)} \\
  & $\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)+1,Hgt(C)+1)} \\
  & \quad\quad $\Rightarrow$ \textrm{Col(ClimbRight(C))} = \textrm{Col(C)} $\land$ \textrm{Hgt(ClimbLeft(C))} $=$ \textrm{Hgt(C)} \\
  & \textrm{Col(C)} $\neq$ Environnement::Width(Envi(G))-1 \\
  & \quad\quad $\land$ \textrm{Screen::CellNature(Envi(C),Col(C)+1,Hgt(C)+1)} \textbf{notin} \{\textbf{MTL}, \textbf{PLT} \} \\
  & \quad\quad $\land$ $\neg$$\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C)+1,Hgt(C)+1)} \\
  & \quad\quad $\Rightarrow$ \textrm{Col(ClimbRight(C))} = \textrm{Col(C)}+1 $\land$ \textrm{Hgt(ClimbLeft(C))} = \textrm{Hgt(C)}+1 \\
  \textrm{[Step]}:
  & on définit le prédicat WillFall pour simplifier les équations suivantes: \\
  & \textbf{WillFall}\texttt{(C)} \textbf{defined by} (\textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C)-1)} $\in$ \{\textbf{HOL}, \textbf{EMP}, \textbf{HDR} \}  \\
  & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad $\land$ $\neg$$\exists$ \textrm{Guard} g $\in$ \textrm{Environment::CellContent(Envi(C),Col(C),Hgt(C)-1)} \\
  & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad $\land$ \textrm{Environment::CellNature(Envi(C),Col(C),Hgt(C))} $\notin$ \{\textbf{LAD}, \textbf{HDR} \} ) \\
  & \textrm{WillFall(C)} $\Rightarrow$ \textrm{Step(G)} = \textrm{GoDown(G)} \\
  & $\neg$ \texttt{WillFall(C)} \\
  & \quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{HOL}) \\
  & \quad\quad $\land$ \textrm{TimeInHole(G)} $<$ 5 \\
  & \quad\quad $\Rightarrow$ \textrm{TimeInHole(Step(G))} = \textrm{TimeInHole(G)} $+$ 1 \\
  & $\neg$ \texttt{WillFall(C)} \\
  & \quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{HOL}) \\
  & \quad\quad $\land$ \textrm{TimeInHole(G)} $=$ 5 \\
  & \quad\quad $\Rightarrow$ (\textrm{Behaviour(G)} $=$ \textbf{Left} $\Rightarrow$ \textrm{Step(G)} = \textrm{ClimbLeft(G)} \\
  & \quad\quad\quad\quad $\land$ \textrm{Behaviour(G)} $=$ \textbf{Right} $\Rightarrow$ \textrm{Step(G)} = \textrm{ClimbRight(G)}) \\
  & $\neg$ \texttt{WillFall(C)} \\
  & \quad\quad $\land$ \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $\neq$ \textbf{HOL} \\
  & \quad\quad $\Rightarrow$ (\textrm{Behaviour(G)} $=$ \textbf{Left} $\Rightarrow$ \textrm{Step(G)} = \textrm{GoLeft(G)} \\
  & \quad\quad\quad\quad $\land$ \textrm{Behaviour(G)} $=$ \textbf{Right} $\Rightarrow$ \textrm{Step(G)} = \textrm{GoRight(G)}\\
  & \quad\quad\quad\quad $\land$ \textrm{Behaviour(G)} $=$ \textbf{Up} $\Rightarrow$ \textrm{Step(G)} = \textrm{GoUp(G)}\\
  & \quad\quad\quad\quad $\land$ \textrm{Behaviour(G)} $=$ \textbf{Down} $\Rightarrow$ \textrm{Step(G)} = \textrm{GoDown(G)})\\
\end{longtable}}

\subsection{Player}

\subsection{Engine}

{\small
\begin{longtable}{rl}
  \textbf{Service}: & \textrm{Engine}  \\
  \textbf{Observators}: & \textbf{const} \texttt{Environment}: \textrm{[Engine]} $\rightarrow$ \textrm{Environment} \\
  & \texttt{Player}: \textrm{[Engine]} $\rightarrow$ \textrm{Player} \\
  & \textbf{const} \texttt{Guards}: \textrm{[Engine]} $\rightarrow$ \textrm{Set\{Guard\}} \\
  & \texttt{Treasures}: \textrm{[Engine]} $\rightarrow$ \textrm{Set\{Item\}} \\
  & \texttt{Status}: \textrm{[Engine]} $\rightarrow$ \textrm{Status} \\
  & \texttt{LevelScore}: \textrm{[Engine]} $\rightarrow$ \textrm{int} \\
  & \texttt{NextCommand}: \textrm{[Engine]} $\rightarrow$ \textrm{Command} \\
  \textbf{Constructors}: &\texttt{init}: \textrm{EditableScreen} $\times$ \textrm{Coord} $\times$ \textrm{Set\{Coord\}} $\times$ \textrm{Set\{Coord\}} $\rightarrow$ \textrm{[Engine]} \\
  & \quad \textbf{pre} \texttt{init(screen, pCoord, gCoords, tCoords)} \textbf{requires} \textrm{Playable(screen)}\\
  & \quad\quad\quad $\land$ $\forall$ \textrm{Coord} c $\in$ \{pCoord\} \textbf{union} gCoords \textbf{union} tCoords \textrm{CellNature(screen, Col(c), Hgt(c))} = \textbf{EMP} \\
  & \quad\quad\quad $\land$ $\forall$ \textrm{Coord} c1 $\in$ gCoords $\forall$ \textrm{Coord} c2 $\in$ gCoords \\
  & \quad\quad\quad\quad\quad (\textrm{Col(c1)} $=$ \textrm{Col(c2))} $\land$ \textrm{Hgt(c1)} $=$ \textrm{Hgt(c2))}) $\Rightarrow$ c1 $=$ c2\\
  & \quad\quad\quad $\land$ $\forall$ \textrm{Coord} c1 $\in$ tCoords $\forall$ \textrm{Coord} c2 $\in$ tCoords \\
  & \quad\quad\quad\quad\quad (\textrm{Col(c1)} $=$ \textrm{Col(c2))} $\land$ \textrm{Hgt(c1)} $=$ \textrm{Hgt(c2))}) $\Rightarrow$ c1 $=$ c2\\
  & \quad\quad\quad $\land$ $\forall$ \textrm{Coord} c $\in$ gCoords (\textrm{Col(c)} $\neq$ \textrm{Col(pCoord)} $\lor$ \textrm{Hgt(c)} $\neq$ \textrm{Hgt(pCoord)})\\
  & \quad\quad\quad $\land$ $\forall$ \textrm{Coord} c $\in$ tCoords (\textrm{Col(c)} $\neq$ \textrm{Col(pCoord)} $\lor$ \textrm{Hgt(c)} $\neq$ \textrm{Hgt(pCoord)})\\
  & \quad\quad\quad $\land$ $\forall$ \textrm{Coord} c $\in$ tCoords \textrm{CellNature(screen, Col(c), Hgt(c)-1)} $\in$ \{\textbf{PLT}, \textbf{MTL}\} \\
  & \quad\quad\quad\quad\quad $\lor$ c $\in$ gCoords \\
  \textbf{Operators}: &\texttt{Step}: \textrm{[Engine]} $\rightarrow$ \textrm{[Engine]} \\
  & \quad \textbf{pre} \textrm{Step(E)} \textbf{requires} \textrm{Status(E)} = \textbf{Playing}\\
  \textbf{Observations}:&\\
  \textrm{[invariant]}:& \textrm{Player(E)} $\in$ \textrm{CellContent(Environment(E), Col(Player(E)), Hgt(Player(E)))}\\
  & \quad\quad $\land$ $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(Environment(E))[} $\times$ \texttt{[0;Height(Environment(E))[}\\
  & \quad\quad\quad\quad \textrm{Player(E)} $\in$ \textrm{CellContent(Environment(E), x, y)} $\Rightarrow$ (\textrm{Col(Player(E))} $=$ x $\land$ \textrm{Hgt(Player(E))} $=$ y)\\
  & $\forall$ \textrm{Guard} g $\in$ \textrm{Guards(E)} g $\in$ \textrm{CellContent(Environment(E), Col(g), Hgt(g))}\\
  & \quad\quad $\land$ $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(Environment(E))[} $\times$ \texttt{[0;Height(Environment(E))[}\\
  & \quad\quad\quad\quad $\forall$ \textrm{Guard} g $\in$ \textrm{CellContent(Environment(E), x, y)} \\
  & \quad\quad\quad\quad\quad\quad $\Rightarrow$ (g $\in$ \textrm{Guards(E)} $\land$ \textrm{Col(g)} $=$ x $\land$ \textrm{Hgt(g)} $=$ y)\\
  & $\forall$ \textrm{Item} i $\in$ \textrm{Treasures(E)} i $\in$ \textrm{CellContent(Environment(E), Col(i), Hgt(i))}\\
  & \quad\quad $\land$ $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(Environment(E))[} $\times$ \texttt{[0;Height(Environment(E))[}\\
  & \quad\quad\quad\quad $\forall$ \textrm{Treasures} i $\in$ \textrm{CellContent(Environment(E), x, y)} \\
  & \quad\quad\quad\quad\quad\quad $\Rightarrow$ (i $\in$ \textrm{Treasures(E)} $\land$ \textrm{Col(i)} $=$ x $\land$ \textrm{Hgt(i)} $=$ y)\\
  & $\forall$ \textrm{Hole} h $\in$ \textrm{Holes(E)} CellNature(Environment(E), Col(h), Hgt(h)) $=$ \textbf{HOL}\\
  & \quad\quad $\land$ $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(Environment(E))[} $\times$ \texttt{[0;Height(Environment(E))[}\\
  & \quad\quad\quad\quad \textrm{CellNature(Environment(E), x, y)} $=$ \textbf{HOL}\\
  & \quad\quad\quad\quad\quad\quad $\Rightarrow$ ($\exists$ \textrm{Hole} h $\in$ \textrm{Holes(E)} \textrm{Col(h)} $=$ x $\land$ \textrm{Hgt(h)} $=$ y)\\
  \textrm{[init]}:& \textrm{Status(init(s, pC, gC, tC))} $=$ \textbf{Playing}\\
  & \textrm{LevelScore(init(s, pC, gC, tC))} $=$ 0\\
  & \textrm{Width(Environment(init(s, pC, gC, tC)))} $=$ \textrm{Width(s)} $\land$ \textrm{Height(Environment(init(s, pC, gC, tC)))} $=$ \textrm{Height(s)} \\
  & \quad\quad $\land$ $\forall$ $(\mathtt{x},\mathtt{y})$ $\in$ \texttt{[0;Width(s)[} $\times$ \texttt{[0;Height(s)[}\\
  & \quad\quad\quad\quad \textrm{CellNature(Environment(init(s, pC, gC, tC)), x, y)} $=$ \textrm{CellNature(s, x, y)}\\
  & \textrm{Col(Player(init(s, pC, gC, tC)))} $=$ \textrm{Col(pC)} $\land$ \textrm{Hgt(Player(init(s, pC, gC, tC)))} $=$ \textrm{Hgt(pC)}\\
  & $\forall$ \textrm{Coord} c $\in$ gC $\exists$ \textrm{Guard} g $\in$ \textrm{Guards(init(s, pC, gC, tC))} (\textrm{Col(g)} $=$ \textrm{Col(c)} $\land$ \textrm{Hgt(g)} $=$ \textrm{Hgt(c)})\\
  & \quad\quad $\land$ $\forall$ \textrm{Guard} g $\in$ \textrm{Guards(init(s, pC, gC, tC))} $\exists$ \textrm{Coord} c $\in$ gC\\
  & \quad\quad\quad\quad (\textrm{Col(g)} $=$ \textrm{Col(c)} $\land$ \textrm{Hgt(g)} $=$ \textrm{Hgt(c)})\\
  & $\forall$ \textrm{Coord} c $\in$ tC $\exists$ \textrm{Item} t $\in$ \textrm{Treasures(init(s, pC, gC, tC))} (\textrm{Col(t)} $=$ \textrm{Col(c)} $\land$ \textrm{Hgt(t)} $=$ \textrm{Hgt(c)})\\
  & \quad\quad $\land$ $\forall$ \textrm{Item} t $\in$ \textrm{Treasures(init(s, pC, gC, tC))} $\exists$ \textrm{Coord} c $\in$ tC\\
  & \quad\quad\quad\quad (\textrm{Col(t)} $=$ \textrm{Col(c)} $\land$ \textrm{Hgt(t)} $=$ \textrm{Hgt(c)})\\
  \textrm{[Step]}:&\\
  & \textrm{Player(Step(E))} $=$ \textrm{Step(Player(E))}\\
  & $\forall$ \textrm{Guard} g $\in$ \textrm{Guards(Step(E))} $\exists$ \textrm{Guard} g' $\in$ \textrm{Guards(E))} g' $=$ \textrm{Step(g)}\\
  & $\forall$ \textrm{Item} t $\in$ \textrm{Treasures(E)} $\exists$ \textrm{Guard} g $\in$ \textrm{CellContent(Environment(S), Col(t), Hgt(t))}\\
  & \quad\quad $\land$ \textrm{CellNature(Environment(E), Col(Step(G)), Hgt(Step(G))} $\ne$ \textbf{HOL}\\
  & \quad\quad $\Rightarrow$ $\exists$ \textrm{Treasure} t2 $\in$ \textrm{Treasures(Step(E))}\\
  & \quad\quad\quad\quad \textrm{Id(t2)} $=$ \textrm{Id(t)} $\land$ \textrm{Col(t2)} $=$ \textrm{Col(Step(G))} $\land$ \textrm{Hgt(t2)} $=$ \textrm{Hgt(Step(G))}\\
  & $\forall$ \textrm{Item} t $\in$ \textrm{Treasures(E)} $\exists$ \textrm{Guard} g $\in$ \textrm{CellContent(Environment(S), Col(t), Hgt(t))}\\
  & \quad\quad $\land$ \textrm{CellNature(Environment(E), Col(Step(G)), Hgt(Step(G))} $=$ \textbf{HOL}\\
  & \quad\quad $\Rightarrow$ $\exists$ \textrm{Treasure} t2 $\in$ \textrm{Treasures(Step(E))}\\
  & \quad\quad\quad\quad \textrm{Id(t2)} $=$ \textrm{Id(t)} $\land$ \textrm{Col(t2)} $=$ \textrm{Col(Step(G))} $\land$ \textrm{Hgt(t2)} $=$ \textrm{Hgt(Step(G))} $+$ 1\\
& $\forall$ \textrm{Item} t $\in$ \textrm{Treasures(E)} $\neg$ $\exists$ \textrm{Guard} g $\in$ \textrm{CellContent(Environment(S), Col(t), Hgt(t))}\\
  & \quad\quad $\land$ t $\in$ \textrm{Treasures(Step(E))} \\
  & \quad\quad $\Rightarrow$ $\exists$ \textrm{Treasure} t2 $\in$ \textrm{Treasures(Step(E))}\\
  & \quad\quad\quad\quad \textrm{Id(t2)} $=$ \textrm{Id(t)} $\land$ \textrm{Col(t2)} $=$ \textrm{Col(t)} $\land$ \textrm{Hgt(t2)} $=$ \textrm{Hgt(t)}\\
  & $\exists$ \textrm{Item} t $\in$ \textrm{Treasures(E)} \textrm{Col(i)} $=$ \textrm{Col(Player(E))} $\land$ \textrm{Hgt(i)} $=$ \textrm{Hgt(Player(E))}\\
  & \quad\quad $\land$ $\neg$$\exists$ \textrm{Guard} g $\in$ \textrm{Guards(E)} (\textrm{Col(g)} $=$ \textrm{Col(Player(E))} $\land$ \textrm{Hgt(g)} $=$ \textrm{Hgt(Player(E))})\\
  & \quad\quad $\Rightarrow$ (t $\notin$ Treasures(Step(E)) $\land$ \textrm{LevelScore(Step(E))} $=$ \textrm{LevelScore(E)} $+$ 1)\\
  & $\neg$$\exists$ \textrm{Item} t $\in$ \textrm{Treasures(E)} \textrm{Col(i)} $=$ \textrm{Col(Player(E))} $\land$ \textrm{Hgt(i)} $=$ \textrm{Hgt(Player(E))}\\
  & \quad\quad $\Rightarrow$ \textrm{LevelScore(Step(E))} $=$ \textrm{LevelScore(E)}\\
  & $\forall$ \textrm{Item} t $\in$ \textrm{Treasures(E)} \textrm{Col(i)} $\ne$ \textrm{Col(Player(E))} \textbf{or} \textrm{Hgt(i)} $\ne$ \textrm{Hgt(Player(E))}\\
  & \quad\quad $\Rightarrow$ t $\in$ \textrm{Treasures(Step(E))}\\
  & \textrm{Treasures(Step(E))} $= \emptyset$ $\Rightarrow$ \textrm{Status(Step(E))} $=$ \textbf{Win}\\
  & $\exists$ \textrm{Guard} g $\in$ \textrm{Guards(Step(E))} (\textrm{Col(g)} $=$ \textrm{Col(Player(E))} $\land$ \textrm{Hgt(g)} $=$ \textrm{Hgt(Player(E))}) \\
  & \quad\quad $\land$ \textrm{Treasures(Step(E))} $\neq \emptyset$\\
  & \quad\quad $\Rightarrow$ \textrm{Status(Step(E))} $=$ \textbf{Loss}\\
  & \textrm{Treasures(Step(E))} $\ne \emptyset$\\
  & \quad\quad $\land$ $\neg$$\exists$ \textrm{Guard} g $\in$ \textrm{Guards(Step(E))} (\textrm{Col(g)} $=$ \textrm{Col(Player(E))} $\land$ \textrm{Hgt(g)} $=$ \textrm{Hgt(Player(E))}) \\
  & \quad\quad $\land$ $\neg$$\exists$ \textrm{Hole} h $\in$ \textrm{Holes(E))} (\textrm(T(h) $=$ 15 $\land$ \textrm{Col(h)} $=$ \textrm{Col(Player(E))} $\land$ \textrm{Hgt(h)} $=$ \textrm{Hgt(Player(E))})\\
  & \quad\quad $\Rightarrow$ \textrm{Status(Step(E))} $=$ \textbf{Playing}\\
  & $\forall$ \textrm{Hole} h $\in$ \textrm{Holes(Step(E))} h $\notin$ \textrm{Holes(E)} $\Rightarrow$ \textrm{T(h)} $=$ 0.\\
  & $\forall$ \textrm{Hole} h $\in$ \textrm{Holes(E)} h \textrm{T(h)} $<$ 15\\
  & \quad\quad $\Rightarrow$ $\exists$ h2 $\in$ \textrm{Holes(Step(E))} \textrm{Col(h2)} $=$ \textrm{Col(h)} $\land$ \textrm{Hgt(h2)} $=$ \textrm{Hgt(h)} $\land$ \textrm{T(h2)} $=$ \textrm{T(h)} $+$ 1\\
  & $\forall$ \textrm{Hole} h $\in$ \textrm{Holes(E)} h \textrm{T(h)} $=$ 15\\
  & \quad\quad $\Rightarrow$ (h $\notin$ \textrm{Holes(Step(E))}\\
  & \quad\quad\quad\quad $\land$ (\textrm{Col(Player(E))} $=$ \textrm{Col(h)} $\land$ \textrm{Hgt(Player(E))} $=$ \textrm{Hgt(h)}) $\Rightarrow$ \textrm{Status(Step(E))} $=$ \textbf{Loss}\\
  & \quad\quad\quad\quad $\exists$ \textrm{Guard} g $\in$ \textrm{CellContent(Environment(E), Col(h), Hgt(h))}\\
  & \quad\quad\quad\quad\quad\quad $\Rightarrow$ $\exists$ \textrm{Guard} g2 $\in$ \textrm{Guards(Step(E))}\\
  & \quad\quad\quad\quad\quad\quad\quad \textrm{Id(g2)} $=$ \textrm{Id(g)} $\land$ \textrm{Col(g2)} $=$ \textrm{InitCol(g2)} $\land$ \textrm{Hgt(g2)} $=$ \textrm{InitHgt(g2)}\\
\end{longtable}}

\subsection{Game}
{\small
\begin{longtable}{rl}
  \textbf{Service}:&\textrm{Game}\\
  \textbf{Observators}:& \textbf{const} \texttt{Levels}: \textrm{[Game]} $\rightarrow$ \textrm{List\{Level\}}\\
  & \texttt{Engine}: \textrm{[Game]} $\rightarrow$ \textrm{Engine}\\
  & \texttt{LevelIndex}: \textrm{[Game]} $\rightarrow$ \textrm{int}\\
  & \texttt{Score}: \textrm{[Game]} $\rightarrow$ \textrm{int}\\
  & \texttt{HP}: \textrm{[Game]} $\rightarrow$ \textrm{int}\\
  \textbf{Constructors}:& \texttt{init}: \textrm{List\{Level\}} $\rightarrow$ \textrm{[Game]}\\
  &\quad\quad \textbf{pre}: \textrm{init(levels)} \textbf{requires} \textrm{levels} $\neq \emptyset$\\
  \textbf{Operators}:& \texttt{CheckStateAndUpdate}: \textrm{Game} $\rightarrow$ \textrm{Game}\\
  & \quad\quad \textbf{pre}: \textrm{CheckStateAndUpdate(G)} \textbf{requires} \textrm{LevelIndex(G)} $<$ \textrm{$|$Levels(G)$|$}\\
  & \quad\quad\quad\quad $\land$ \textrm{HP(G)} $> 0$.\\
  \textbf{Observations}:&\\
  \textrm{[init]}:& \textrm{Levels(init(levels))} $=$ \textrm{levels}\\
  & \textrm{LevelIndex(init(levels))} $ = 0$\\
  & \textrm{Engine(init(levels))} $ = $ \textrm{Engine::init(Screen(levels[0]), PlayerCoord(levels[0]),}\\
  & \quad\quad\quad\quad \textrm{GuardCoords(levels[0]), TreasureCoords(levels[0]))}\\
  & \textrm{Score(init(levels))} $ = 0$\\
  & \textrm{HP(init(levels))} $ = 3$\\
  \textrm{[CheckStateAndUpdate]}:& \textrm{Status(Engine(G))} $=$ \textbf{Loss}\\
  & \quad\quad $\Rightarrow$ (\textrm{HP(CheckStateAndUpdate(G))} $=$ \textrm{HP(G)-1}\\
  & \quad\quad\quad\quad $\land$ \textrm{Engine(CheckStateAndUpdate(G))} $=$ \\
  & \quad\quad\quad\quad\quad\quad  \textrm{Engine::init(Screen(Levels(G)[LevelIndex(G)]), PlayerCoord(Levels(G)[LevelIndex(G)]),}\\
  & \quad\quad\quad\quad\quad\quad  \textrm{GuardCoords(Levels(G)[LevelIndex(G)]), TreasureCoords(Levels(G)[LevelIndex(G)]))})\\
  & \textrm{Status(Engine(CheckAndUpdate(G)))} $\neq$ \textbf{Loss} $\Rightarrow$ \textrm{HP(CheckAndUpdate(G))} $=$ \textrm{HP(G)}\\
  & \textrm{Status(Engine(G))} $=$ \textbf{Win}\\
  & \quad\quad $\Rightarrow$ (\textrm{Score(CheckStateAndUpdate(G))} $=$ \textrm{Score(G)} $+$ \textrm{LevelScore(Engine(G))}\\
  & \quad\quad\quad\quad $\land$ \textrm{LevelIndex(CheckStateAndUpdate(G))} $=$ \textrm{LevelIndex(G)} $+$ 1\\
  & \quad\quad\quad\quad $\land$ (\textrm{LevelIndex(CheckStateAndUpdate(G))} $<$ \textrm{$|$Levels(G)$|$} $\Rightarrow$\\
  & \quad\quad\quad\quad\quad\quad \textrm{Engine(CheckStateAndUpdate(G))} $=$\\
  & \quad\quad\quad\quad\quad\quad  \textrm{Engine::init(Screen(Levels(G)[LevelIndex(CheckStateAndUpdate(G))]),}\\
  & \quad\quad\quad\quad\quad\quad\quad\quad \textrm{PlayerCoord(Levels(G)[LevelIndex(CheckStateAndUpdate(G))]),}\\
  & \quad\quad\quad\quad\quad\quad\quad\quad  \textrm{GuardCoords(Levels(G)[LevelIndex(CheckStateAndUpdate(G))]),}\\
  & \quad\quad\quad\quad\quad\quad\quad\quad  \textrm{TreasureCoords(Levels(G)[LevelIndex(CheckStateAndUpdate(G))]))}))\\
  & \textrm{Status(Engine(CheckAndUpdate(G)))} $\neq$ \textbf{Win} $\Rightarrow$ \textrm{LevelIndex(CheckAndUpdate(G))} $=$ \textrm{LevelIndex(G)}\\
  & \textrm{Status(Engine(CheckAndUpdate(G)))} $=$ \textbf{Playing} $\Rightarrow$ \textrm{Engine(CheckAndUpdate(G))} $=$ \textrm{Engine(G)}\\
\end{longtable}}

\section{Extensions}

\subsection{Gardes améliorés}

\subsubsection{Un pas sur deux}
Dans le service Engine, on ajoute et modifie:
{\small
\begin{longtable}{rl}
  \textbf{Observators}:&\texttt{GuardTurn}: \textrm{[Engine]} $\rightarrow$ \textrm{boolean}\\
  \textbf{Observations}:&\\
  \textrm{[init]}:& \textrm{GuardTurn(init(screen, pCoord, gCoords, tCoords))} $=$ \textrm{false}\\
  \textrm{[step]}:& \textrm{GuardTurn(step(E))} $=$ \textbf{not} \texttt{GuardTurn(E)}\\
  & \textrm{GuardTurn(E)} \textbf{implies} \textbf{forall} \textrm{Guard} g \textbf{in} \textrm{Guards(Step(E))} \textbf{exists} \textrm{Guard} g' \textbf{in} \textrm{Guards(E))} g' $=$ \textrm{Step(g)}\\
  & \textbf{not} \textrm{GuardTurn(E)} \textbf{implies} \textbf{forall} \textrm{Guard} g \textbf{in} \textrm{Guards(Step(E))} \textbf{exists} \textrm{Guard} g' \textbf{in} \textrm{Guards(E))} g' $=$ \textrm{g}\\
\end{longtable}}

\subsubsection{Descendre les échelles}
Dans le service Guard, on modifie:
{\small
\begin{longtable}{rl}
  \textbf{Observations}:&\\
  \textrm{[invariant]}:& (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad\quad\quad \textbf{or} (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $=$ \textbf{LAD}\\
  & \quad\quad\quad\quad\quad\quad \textbf{and} \textbf{not exists} \textrm{Guard} g \textbf{in} \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)}))\\
  & \quad\quad \textbf{and} \textrm{Hgt(G)} $>$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad \textbf{and} (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} \textbf{not in} \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad \textbf{or} \textbf{exists} \textrm{Guard} g \textbf{in} \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)} \\
  & \quad\quad\quad\quad \textbf{implies} \textrm{Hgt(G) - Character::Hgt(Target(G))} $<$ $|$\textrm{Character::Col(Target(G)) - Col(G)})$|$)\\
  & \quad\quad \textbf{implies} \textrm{Behaviour(G)} $=$ \textbf{Down} \\

  & \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad \textbf{and} \textrm{Hgt(G)} $=$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad \textbf{and} ( \textrm{Col(G)} $=$ \textrm{Character::Col(Target(G))}\\
  & \quad\quad\quad\quad \textbf{or} $|$\textrm{Character::Hgt(G) - Hgt(Target(G))}$|$ $<$ $|$\textrm{Character::Col(Target(G)) - Col(G)})$|$) \\
  & \quad\quad \textbf{implies} \textrm{Behaviour(G)} $=$ \textbf{Neutral} \\

  & (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} \textbf{in} \{\textbf{PLT}, \textbf{MTL}  \} \\
  & \quad\quad\quad\quad \textbf{or} ( \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $=$ \textbf{LAD} \\
  & \quad\quad\quad\quad\quad\quad \textbf{and} \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\neq$ \textbf{LAD}) \\
  & \quad\quad\quad\quad \textbf{or} \textbf{exists} \textrm{Guard} g \textbf{in} \textrm{Environment::CellContent(Envi(G),Col(G),Hgt(G)-1)}) \\
  & \quad\quad \textbf{and} \textrm{Col(G)} $=$ \textrm{Character::Col(Target(G))} \\
  & \quad\quad \textbf{and} (\textrm{Hgt(G)} $=$ \textrm{Character::Hgt(Target(G))} \\
  & \quad\quad\quad\quad \textbf{or} (\textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G))} $\neq$ \textbf{LAD})\\
  & \quad\quad\quad\quad\quad\quad \textbf{and} \textrm{Environment::CellNature(Envi(G),Col(G),Hgt(G)-1)} $\neq$ \textbf{LAD}) \\
  & \quad\quad \textbf{implies} \textrm{Behaviour(G)} $=$ \textbf{Neutral} \\
\end{longtable}}

\end{document}
